name: Notify RingCentral When Reviewer Added
on:
  workflow_call:
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Map team to webhook
        id: map
        run: |
          TEAM="${{ github.event.requested_team.name }}"
          if [[ "$TEAM" == "DA" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjMyMzIzOTkzODcifQ.dIwsaKBTQ0pcw9Y1dnqC_R_DZJ_4_mEpzZUDH1HZ44Y" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi
      - name: Send notification to RingCentral
        if: steps.map.outputs.notify == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
        run: |
          echo "GH_API_TOKEN last 5: ${GH_API_TOKEN: -5}"
          API_RESPONSE=$(curl -s -H "Authorization: token $GH_API_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/$SENDER_LOGIN")
          echo "GitHub API response: $API_RESPONSE"
          FULL_NAME=$(echo "$API_RESPONSE" | jq -r '.name')
          if [ -z "$FULL_NAME" ] || [ "$FULL_NAME" = "null" ]; then
            FULL_NAME="$SENDER_LOGIN"
          fi
          echo "FULL_NAME: $FULL_NAME"
          echo "URL: ${{ github.event.pull_request.html_url }}"
          echo "Additions: ${{ github.event.pull_request.additions }}"
          echo "Deletions: ${{ github.event.pull_request.deletions }}"
          curl -X POST -H 'Content-Type: application/json' \
            -d '{
              "iconUri": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "text": "**PR ready for review**: '${{ github.event.pull_request.html_url }}'\n**Requested by**: '$FULL_NAME'\n**Changes**: +'${{ github.event.pull_request.additions }}' -'${{ github.event.pull_request.deletions }}' lines\n\nRemember to use helpful emojis to let the team know if you approve or have questions!\nüëÄ Currently reviewing\n‚úÖ Approved\n‚ùì Questions? Reply with comments here"
            }' \
            "${{ steps.map.outputs.webhook }}"
