name: Notify RingCentral When Reviewer Added
on:
  workflow_call:
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Map team to webhook
        id: map
        run: |
          TEAM="${{ github.event.requested_team.name }}"
          if [[ "$TEAM" == "DA" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjIzMjYzNjQxODcifQ.-CUqmsraBYvjn1Bgq4TElNfunV1aYY2--Mf_ETmrF1s" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi
      - name: Send notification to RingCentral
        if: steps.map.outputs.notify == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
        run: |
          FULL_NAME=$(curl -s -H "Authorization: token $GH_API_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/$SENDER_LOGIN" | jq -r '.name')
          if [ -z "$FULL_NAME" ] || [ "$FULL_NAME" = "null" ]; then
            FULL_NAME="$SENDER_LOGIN"
          fi
          curl -X POST -H 'Content-Type: application/json' \
            -d '{
                "iconUri": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "text": "**PR ready for review**: ${{ github.event.pull_request.html_url }}\n**Requested by**: $FULL_NAME\n**Changes**: +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }} lines\n\nRemember to use helpful emojis to let the team know if you approve or have questions!\nüëÄ Currently reviewing\n‚úÖ Approved\n‚ùì Questions? Reply with comments here"
            }' \
            "${{ steps.map.outputs.webhook }}"
