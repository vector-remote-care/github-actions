name: Notify RingCentral When Reviewer Added
on:
  workflow_call:
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Map team to webhook
        id: map
        run: |
          TEAM="${{ github.event.requested_team.name }}"
          if [[ "$TEAM" == "Data Team" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjIzMjYzNjQxODcifQ.-CUqmsraBYvjn1Bgq4TElNfunV1aYY2--Mf_ETmrF1s" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$TEAM" == "Engineering" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjMyNTA2MTAyMDMifQ.-wV565kT6B6proC1VqGOsHacl4bFoyXVWlkt-2NJUQw" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$TEAM" == "DB Management" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjMyNzQ3NjAyMTkifQ.l1Qrlwla_5LaqkCMt-mAGzVNn4cPrqHS4FfBXQ_4R3g" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Calculate PR size
        id: size
        if: steps.map.outputs.notify == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.BUMP_GITHUB_TOKEN }}
        run: |
          FILES_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate)
          ADDITIONS=0
          DELETIONS=0

          while IFS= read -r file; do
            filename=$(echo "$file" | jq -r '.filename')
            adds=$(echo "$file" | jq -r '.additions')
            dels=$(echo "$file" | jq -r '.deletions')

            if [[ "$filename" =~ (package-lock\.json|yarn\.lock|pnpm-lock\.yaml|Gemfile\.lock|composer\.lock|Cargo\.lock|poetry\.lock)$ ]]; then
              echo "Skipping lock file: $filename"
              continue
            fi

            if [[ "$filename" =~ \.generated\. ]] || [[ "$filename" =~ /generated/ ]]; then
              echo "Skipping generated file: $filename"
              continue
            fi

            if [[ "$filename" =~ \.(test|spec)\. ]] || [[ "$filename" =~ /__tests__/ ]] || [[ "$filename" =~ (^|/)tests?/ ]]; then
              echo "Skipping test file: $filename"
              continue
            fi

            ADDITIONS=$((ADDITIONS + adds))
            DELETIONS=$((DELETIONS + dels))
          done < <(echo "$FILES_JSON" | jq -c '.[]')

          WEIGHTED_SIZE=$(echo "$ADDITIONS + ($DELETIONS * 0.5)" | bc | cut -d'.' -f1)

          if [ "$WEIGHTED_SIZE" -lt 10 ]; then
            SIZE_LABEL="XS"
            SIZE_ICON="üü¢"
          elif [ "$WEIGHTED_SIZE" -lt 100 ]; then
            SIZE_LABEL="S"
            SIZE_ICON="üü¢"
          elif [ "$WEIGHTED_SIZE" -lt 500 ]; then
            SIZE_LABEL="M"
            SIZE_ICON="üü°"
          elif [ "$WEIGHTED_SIZE" -lt 1000 ]; then
            SIZE_LABEL="L"
            SIZE_ICON="üü†"
          else
            SIZE_LABEL="XL"
            SIZE_ICON="üî¥"
          fi

          echo "Filtered additions: $ADDITIONS"
          echo "Filtered deletions: $DELETIONS"
          echo "Weighted size: $WEIGHTED_SIZE"
          echo "Size label: $SIZE_LABEL"

          echo "label=size/$SIZE_LABEL" >> $GITHUB_OUTPUT
          echo "icon=$SIZE_ICON" >> $GITHUB_OUTPUT
          echo "display=$SIZE_ICON $SIZE_LABEL" >> $GITHUB_OUTPUT

      - name: Add size label to PR
        if: steps.map.outputs.notify == 'true' && steps.size.outputs.label
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.BUMP_GITHUB_TOKEN }}
        run: |
          EXISTING_LABELS=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json labels -q '.labels[].name' | grep "^size/" || true)
          for label in $EXISTING_LABELS; do
            gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --remove-label "$label" || true
          done

          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --add-label "${{ steps.size.outputs.label }}"

      - name: Send notification to RingCentral
        if: steps.map.outputs.notify == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.BUMP_GITHUB_TOKEN }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
        run: |
          API_RESPONSE=$(curl -s -H "Authorization: token $GH_API_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/$SENDER_LOGIN")
          FULL_NAME=$(echo "$API_RESPONSE" | jq -r '.name')
          if [ -z "$FULL_NAME" ] || [ "$FULL_NAME" = "null" ]; then
            FULL_NAME="$SENDER_LOGIN"
          fi
          echo "FULL_NAME: $FULL_NAME"
          echo "URL: ${{ github.event.pull_request.html_url }}"
          echo "Additions: ${{ github.event.pull_request.additions }}"
          echo "Deletions: ${{ github.event.pull_request.deletions }}"
          curl -X POST -H 'Content-Type: application/json' \
            -d "{\"iconUri\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\", \"text\": \"**PR ready for review**: ${{ github.event.pull_request.html_url }}\\n**Requested by**: $FULL_NAME\\n**Requesting Review From**: ${{ github.event.requested_team.name }}\\n**Changes**: +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }} lines ${{ steps.size.outputs.display }}\\n\\nRemember to use helpful emojis to let the team know if you approve or have questions!\\nüëÄ Currently reviewing\\n‚úÖ Approved\\n‚ùì Questions? Reply with comments here\"}" \
            "${{ steps.map.outputs.webhook }}"
