name: Notify RingCentral When Reviewer Added
on:
  workflow_call:
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Map team to webhook
        id: map
        run: |
          TEAM="${{ github.event.requested_team.name }}"
          if [[ "$TEAM" == "DA" ]]; then
            echo "webhook=https://hooks.ringcentral.com/webhook/v2/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvdCI6ImMiLCJvaSI6IjExNjUzODU3MjkiLCJpZCI6IjMyMzIzOTkzODcifQ.dIwsaKBTQ0pcw9Y1dnqC_R_DZJ_4_mEpzZUDH1HZ44Y" >> $GITHUB_OUTPUT
            echo "notify=true" >> $GITHUB_OUTPUT
            exit 0
          fi
      - name: Send notification to RingCentral
        if: steps.map.outputs.notify == 'true'
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
        run: |
          FULL_NAME=$(curl -s -H "Authorization: token $GH_API_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/users/$SENDER_LOGIN" | jq -r '.name')
          if [ -z "$FULL_NAME" ] || [ "$FULL_NAME" = "null" ]; then
            FULL_NAME="$SENDER_LOGIN"
          fi
          echo "FULL_NAME: $FULL_NAME"
          echo "URL: ${{ github.event.pull_request.html_url }}"
          echo "Additions: ${{ github.event.pull_request.additions }}"
          echo "Deletions: ${{ github.event.pull_request.deletions }}"
          curl -X POST -H 'Content-Type: application/json' \
            -d "$(jq -n \
              --arg url \"${{ github.event.pull_request.html_url }}\" \
              --arg name \"$FULL_NAME\" \
              --arg additions \"${{ github.event.pull_request.additions }}\" \
              --arg deletions \"${{ github.event.pull_request.deletions }}\" \
              --arg text \"**PR ready for review**: $url\\n**Requested by**: $name\\n**Changes**: +$additions -$deletions lines\\n\\nRemember to use helpful emojis to let the team know if you approve or have questions!\\nüëÄ Currently reviewing\\n‚úÖ Approved\\n‚ùì Questions? Reply with comments here\" \
              '{iconUri: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png", text: $text}'\n+            )" \
            "${{ steps.map.outputs.webhook }}"
